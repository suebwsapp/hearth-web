---
import Layout from "../../layouts/Layout.astro";
import { siteConfig, getAbsoluteUrl, buildWebSiteJsonLd } from "../../config/site";
import { flattenMessages } from "../../utils/flattenMessages";
import LandingPageWithI18n from "../../components/LandingPageWithI18n";

export async function getStaticPaths() {
  const localeModules = import.meta.glob<{ default: Record<string, unknown> }>(
    "../../locales/*.json",
    { eager: true }
  );
  const localeToMessages: Record<string, Record<string, string>> = {};
  for (const [path, mod] of Object.entries(localeModules)) {
    const match = path.match(/\/([a-z-]+)\.json$/);
    if (match && mod?.default) {
      localeToMessages[match[1]] = flattenMessages(mod.default);
    }
  }
  const enMessages = localeToMessages["en"] ?? {};
  const paths: { params: { locale: string }; props: { lang: string; messages: Record<string, string> } }[] = [];
  for (const locale of siteConfig.locales) {
    if (locale === "en") continue;
    const messages = localeToMessages[locale] ?? enMessages;
    paths.push({
      params: { locale },
      props: { lang: locale, messages },
    });
  }
  return paths;
}

const { lang, messages } = Astro.props;
const title = messages["home.page_title"] ?? siteConfig.defaultTitle;
const description = messages["home.meta_description"] ?? siteConfig.defaultDescription;
const path = `/${lang}/`;
const localeAlternates = [
  ...siteConfig.locales.map((locale) => ({
    hreflang: locale === "en" ? "en" : locale,
    href: getAbsoluteUrl(locale === "en" ? "/" : `/${locale}/`),
  })),
  { hreflang: "x-default", href: getAbsoluteUrl("/") },
];
---

<Layout
  title={title}
  description={description}
  lang={lang}
  path={path}
  localeAlternates={localeAlternates}
  jsonLd={buildWebSiteJsonLd()}
>
  <main
    class="bg-background text-foreground w-screen font-body"
    role="main"
  >
    <LandingPageWithI18n client:load lang={lang} messages={messages} />
  </main>
</Layout>
